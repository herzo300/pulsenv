<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>–ü—É–ª—å—Å –≥–æ—Ä–æ–¥–∞ ‚Äî –û—Ç–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a1a;--card:#111128;--border:rgba(0,180,255,.15);--accent:#00b4ff;--text:#fff;--muted:rgba(255,255,255,.5)}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:80px}

.header{position:sticky;top:0;z-index:100;background:rgba(10,10,26,.95);backdrop-filter:blur(12px);
  padding:16px;border-bottom:1px solid var(--border);text-align:center}
.header h1{font-size:20px;font-weight:800;background:linear-gradient(135deg,#00b4ff,#7c3aed);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header p{font-size:12px;color:var(--muted);margin-top:4px}

.tabs{display:flex;overflow-x:auto;gap:8px;padding:12px 16px;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{flex-shrink:0;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;
  background:var(--card);border:1px solid var(--border);color:var(--muted);cursor:pointer;
  transition:all .2s;white-space:nowrap}
.tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.tab .icon{margin-right:4px}

.search{padding:0 16px 12px}
.search input{width:100%;padding:10px 16px;border-radius:12px;border:1px solid var(--border);
  background:var(--card);color:var(--text);font-size:14px;outline:none}
.search input::placeholder{color:var(--muted)}
.search input:focus{border-color:var(--accent)}

.content{padding:0 16px}
.section{margin-bottom:16px}
.section-title{font-size:14px;font-weight:700;color:var(--accent);margin-bottom:8px;
  display:flex;align-items:center;gap:8px}
.section-title .badge{background:var(--accent);color:#fff;font-size:11px;padding:2px 8px;
  border-radius:10px;font-weight:600}

.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;
  margin-bottom:10px;transition:all .2s}
.card:active{transform:scale(.98)}
.card-title{font-size:14px;font-weight:600;margin-bottom:6px}
.card-row{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);margin-bottom:3px}
.card-row .label{min-width:20px;text-align:center}
.card-tag{display:inline-block;padding:2px 8px;border-radius:8px;font-size:11px;font-weight:600;
  background:rgba(0,180,255,.15);color:var(--accent);margin-top:4px}

.summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.summary-card{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:14px;text-align:center;cursor:pointer;transition:all .2s}
.summary-card:active{transform:scale(.97)}
.summary-card .icon{font-size:28px;margin-bottom:6px}
.summary-card .name{font-size:12px;font-weight:600;margin-bottom:4px}
.summary-card .count{font-size:18px;font-weight:800;color:var(--accent)}

.loading{text-align:center;padding:40px;color:var(--muted)}
.loading .spinner{width:30px;height:30px;border:3px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}

.empty{text-align:center;padding:40px;color:var(--muted);font-size:14px}

.back-btn{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 32px;
  background:var(--accent);color:#fff;border:none;border-radius:25px;font-size:14px;font-weight:600;
  cursor:pointer;box-shadow:0 4px 20px rgba(0,180,255,.3);z-index:100}
</style>
</head>
<body>

<div class="header">
  <h1>üìÇ –û—Ç–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ</h1>
  <p>–ù–∏–∂–Ω–µ–≤–∞—Ä—Ç–æ–≤—Å–∫ ‚Ä¢ data.n-vartovsk.ru ‚Ä¢ 2026</p>
</div>

<div class="tabs" id="tabs"></div>
<div class="search"><input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –¥–∞–Ω–Ω—ã–º..."></div>
<div class="content" id="content">
  <div class="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
</div>

<button class="back-btn" id="backBtn" style="display:none" onclick="showMain()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>

<script>
const API = window.location.origin;
let allData = {};
let currentView = 'main';
let currentDataset = null;

// Telegram Web App
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
  // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–º—É Telegram
  document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color || '#0a0a1a');
  document.documentElement.style.setProperty('--card', tg.themeParams.secondary_bg_color || '#111128');
  document.documentElement.style.setProperty('--text', tg.themeParams.text_color || '#fff');
}

async function loadData() {
  try {
    const r = await fetch(API + '/opendata/full', {
      headers: {'Bypass-Tunnel-Reminder': 'true'}
    });
    if (!r.ok) throw new Error(r.status);
    allData = await r.json();
    showMain();
  } catch(e) {
    document.getElementById('content').innerHTML = 
      '<div class="empty">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message + '</div>';
  }
}

function showMain() {
  currentView = 'main';
  currentDataset = null;
  document.getElementById('backBtn').style.display = 'none';
  document.getElementById('searchInput').value = '';
  
  // Tabs
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '<div class="tab active" onclick="showMain()">üìä –í—Å–µ</div>';
  
  // Summary grid
  let html = '<div class="summary-grid">';
  const entries = Object.entries(allData);
  
  entries.forEach(([key, ds]) => {
    const icon = ds.icon || 'üìÑ';
    const name = ds.name || key;
    const count = ds.total || (ds.rows ? ds.rows.length : 0);
    html += `<div class="summary-card" onclick="showDataset('${key}')">
      <div class="icon">${icon}</div>
      <div class="name">${name}</div>
      <div class="count">${count.toLocaleString('ru')}</div>
    </div>`;
  });
  html += '</div>';
  
  // Total stats
  let totalRows = 0;
  entries.forEach(([k,v]) => totalRows += (v.total || 0));
  html += `<div class="section"><div class="section-title">üìä –ò—Ç–æ–≥–æ <span class="badge">${entries.length} –¥–∞—Ç–∞—Å–µ—Ç–æ–≤</span></div>`;
  html += `<div class="card"><div class="card-row"><span class="label">üìã</span> –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <b>${totalRows.toLocaleString('ru')}</b></div>`;
  html += `<div class="card-row"><span class="label">üïê</span> –ò—Å—Ç–æ—á–Ω–∏–∫: data.n-vartovsk.ru</div></div></div>`;
  
  document.getElementById('content').innerHTML = html;
}
</script>
<script>
function showDataset(key) {
  currentView = 'dataset';
  currentDataset = key;
  const ds = allData[key];
  if (!ds) return;
  
  document.getElementById('backBtn').style.display = 'block';
  
  const rows = ds.rows || [];
  const icon = ds.icon || 'üìÑ';
  const name = ds.name || key;
  
  // Tabs for this dataset
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = `<div class="tab" onclick="showMain()">‚Üê –ù–∞–∑–∞–¥</div>
    <div class="tab active"><span class="icon">${icon}</span>${name}</div>`;
  
  let html = `<div class="section"><div class="section-title">${icon} ${name} <span class="badge">${rows.length} –∑–∞–ø–∏—Å–µ–π</span></div></div>`;
  
  if (rows.length === 0) {
    html += '<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    document.getElementById('content').innerHTML = html;
    return;
  }
  
  // Render based on dataset type
  rows.forEach((row, i) => {
    html += renderRow(key, row, i);
  });
  
  document.getElementById('content').innerHTML = html;
}

function renderRow(key, row, idx) {
  let h = '<div class="card">';
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const title = row.TITLE || row.TITLESM || row.NAME || row.FIO || 
                row.DEPARTMENT || row.ORGANIZATION || row.STREET ||
                row.OBJECT || row.EVENT || row.SECTION || '';
  
  if (title) h += `<div class="card-title">${title}</div>`;
  
  // –ê–¥—Ä–µ—Å
  const addr = row.ADR || row.ADDRESS || row.ADRESS || '';
  if (addr) h += `<div class="card-row"><span class="label">üìç</span>${addr}</div>`;
  
  // –¢–µ–ª–µ—Ñ–æ–Ω
  const tel = row.TEL || row.PHONE || row.TELEPHONE || '';
  if (tel) h += `<div class="card-row"><span class="label">üìû</span><a href="tel:${tel}" style="color:var(--accent)">${tel}</a></div>`;
  
  // Email
  const email = row.EMAIL || row.MAIL || '';
  if (email) h += `<div class="card-row"><span class="label">üìß</span>${email}</div>`;
  
  // URL
  const url = row.URL || row.SITE || row.LINK || '';
  if (url) h += `<div class="card-row"><span class="label">üåê</span><a href="${url}" target="_blank" style="color:var(--accent)">${url}</a></div>`;
  
  // –§–ò–û
  const fio = row.FIO || row.DIRECTOR || row.HEAD || row.TRAINER || '';
  if (fio && fio !== title) h += `<div class="card-row"><span class="label">üë§</span>${fio}</div>`;
  
  // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
  const wt = row.WORK_TIME || row.SCHEDULE || '';
  if (wt) h += `<div class="card-row"><span class="label">üïê</span>${wt}</div>`;
  
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–¥–æ–º–æ–≤, –º–µ—Å—Ç –∏ —Ç.–¥.)
  const cnt = row.CNT || row.COUNT || row.CAPACITY || '';
  if (cnt) h += `<div class="card-row"><span class="label">üìä</span>–ö–æ–ª-–≤–æ: ${cnt}</div>`;
  
  // –¶–µ–Ω–∞/—Ç–∞—Ä–∏—Ñ
  const price = row.PRICE || row.TARIF || row.COST || row.VALUE || '';
  if (price) h += `<div class="card-row"><span class="label">üí∞</span>${price}</div>`;
  
  // –û–ø–∏—Å–∞–Ω–∏–µ
  const desc = row.DESCRIPTION || row.NOTE || row.COMMENT || row.INFO || '';
  if (desc && desc.length < 200) h += `<div class="card-row"><span class="label">üìù</span>${desc}</div>`;
  
  // –ì–æ—Ä–æ–¥
  const city = row.CITY || '';
  if (city && city !== '–≥. –ù–∏–∂–Ω–µ–≤–∞—Ä—Ç–æ–≤—Å–∫') h += `<div class="card-tag">${city}</div>`;
  
  // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –£–ö
  if (key === 'listoumd' && row.MKD) {
    const streets = row.MKD.map(m => m.STREET).filter(Boolean);
    if (streets.length > 0) {
      h += `<div class="card-row"><span class="label">üè†</span>${streets.slice(0,3).join(', ')}${streets.length > 3 ? '...' : ''}</div>`;
    }
  }
  
  // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç
  if (key === 'averagesalary') {
    const period = row.PERIOD || '';
    const salary = row.SALARY || row.AVG_SALARY || row.VALUE || '';
    if (period) h += `<div class="card-row"><span class="label">üìÖ</span>${period}</div>`;
    if (salary) h += `<div class="card-row"><span class="label">üíµ</span>${salary} —Ä—É–±.</div>`;
  }
  
  // –ë–µ–Ω–∑–∏–Ω
  if (key === 'roadgasstationprice') {
    const fuel = row.FUEL_TYPE || row.BRAND || '';
    const pr = row.PRICE || '';
    if (fuel) h += `<div class="card-tag">${fuel}</div> `;
    if (pr) h += `<div class="card-tag">üí∞ ${pr} —Ä—É–±.</div>`;
  }
  
  h += '</div>';
  return h;
}

// –ü–æ–∏—Å–∫
document.getElementById('searchInput').addEventListener('input', function(e) {
  const q = e.target.value.toLowerCase().trim();
  if (!q || q.length < 2) {
    if (currentView === 'main') showMain();
    else if (currentDataset) showDataset(currentDataset);
    return;
  }
  
  let html = `<div class="section"><div class="section-title">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div></div>`;
  let found = 0;
  
  Object.entries(allData).forEach(([key, ds]) => {
    const rows = ds.rows || [];
    rows.forEach((row, i) => {
      const text = JSON.stringify(row).toLowerCase();
      if (text.includes(q)) {
        html += `<div style="font-size:11px;color:var(--accent);padding:2px 0">${ds.icon} ${ds.name}</div>`;
        html += renderRow(key, row, i);
        found++;
      }
    });
    if (found >= 50) return;
  });
  
  if (found === 0) html += '<div class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
  else html += `<div class="empty">–ù–∞–π–¥–µ–Ω–æ: ${found}</div>`;
  
  document.getElementById('content').innerHTML = html;
});

loadData();
</script>
</body>
</html>
