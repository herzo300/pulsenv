<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–∞ –ø—Ä–æ–±–ª–µ–º - –°–æ–æ–±—â–∏–û</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        .stats-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--tg-theme-bg-color, white);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 250px;
            font-size: 14px;
        }
        
        .stats-panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--tg-theme-text-color, #000);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: var(--tg-theme-hint-color, #999);
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--tg-theme-text-color, #000);
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2000;
            background: var(--tg-theme-bg-color, white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            border: 3px solid var(--tg-theme-hint-color, #f3f3f3);
            border-top: 3px solid var(--tg-theme-button-color, #3498db);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .category-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--tg-theme-bg-color, white);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    </div>
    
    <div id="map"></div>
    
    <div class="stats-panel">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
        <div class="stat-item">
            <span class="stat-label">–í—Å–µ–≥–æ –∂–∞–ª–æ–±:</span>
            <span class="stat-value" id="total-count">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">üÜï –ù–æ–≤—ã–µ:</span>
            <span class="stat-value" id="new-count">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">‚öôÔ∏è –í —Ä–∞–±–æ—Ç–µ:</span>
            <span class="stat-value" id="progress-count">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">‚úÖ –†–µ—à–µ–Ω—ã:</span>
            <span class="stat-value" id="resolved-count">0</span>
        </div>
    </div>
    
    <div class="category-legend" id="legend">
        <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
        
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ü–≤–µ—Ç–∞
        const categoryColors = {
            '–î–æ—Ä–æ–≥–∏': '#e74c3c',
            '–ñ–ö–•': '#3498db',
            '–û—Å–≤–µ—â–µ–Ω–∏–µ': '#f39c12',
            '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': '#9b59b6',
            '–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ': '#2ecc71',
            '–≠–∫–æ–ª–æ–≥–∏—è': '#27ae60',
            '–ñ–∏–≤–æ—Ç–Ω—ã–µ': '#e67e22',
            '–¢–æ—Ä–≥–æ–≤–ª—è': '#16a085',
            '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å': '#c0392b',
            '–°–Ω–µ–≥/–ù–∞–ª–µ–¥—å': '#ecf0f1',
            '–ú–µ–¥–∏—Ü–∏–Ω–∞': '#e91e63',
            '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ': '#673ab7',
            '–°–≤—è–∑—å': '#00bcd4',
            '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ': '#795548',
            '–ü–∞—Ä–∫–æ–≤–∫–∏': '#607d8b',
            'other': '#95a5a6'
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([60.9344, 76.5531], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
        const markers = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadReports() {
            try {
                const response = await fetch('http://localhost:8000/api/reports');
                const reports = await response.json();
                
                // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
                markers.clearLayers();
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                let stats = {
                    total: 0,
                    pending: 0,
                    in_progress: 0,
                    resolved: 0,
                    categories: {}
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
                reports.forEach(report => {
                    if (report.lat && report.lng) {
                        stats.total++;
                        
                        // –ü–æ–¥—Å—á–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                        if (report.status === 'pending') stats.pending++;
                        else if (report.status === 'in_progress') stats.in_progress++;
                        else if (report.status === 'resolved') stats.resolved++;
                        
                        // –ü–æ–¥—Å—á–µ—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                        stats.categories[report.category] = (stats.categories[report.category] || 0) + 1;
                        
                        // –¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        const color = categoryColors[report.category] || categoryColors['other'];
                        
                        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                        const marker = L.circleMarker([report.lat, report.lng], {
                            radius: 8,
                            fillColor: color,
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                        
                        // –ü–æ–ø–∞–ø —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                        const statusEmoji = {
                            'pending': 'üÜï',
                            'in_progress': '‚öôÔ∏è',
                            'resolved': '‚úÖ',
                            'rejected': '‚ùå'
                        };
                        
                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0; color: ${color};">${report.category}</h3>
                                <p style="margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusEmoji[report.status] || 'üìã'} ${report.status}</p>
                                <p style="margin: 5px 0;"><strong>–ê–¥—Ä–µ—Å:</strong> ${report.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p style="margin: 5px 0;"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${report.description || report.title}</p>
                                <p style="margin: 5px 0; font-size: 11px; color: #999;">
                                    ${new Date(report.created_at).toLocaleDateString('ru-RU')}
                                </p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markers.addLayer(marker);
                    }
                });
                
                map.addLayer(markers);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('total-count').textContent = stats.total;
                document.getElementById('new-count').textContent = stats.pending;
                document.getElementById('progress-count').textContent = stats.in_progress;
                document.getElementById('resolved-count').textContent = stats.resolved;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
                updateLegend(stats.categories);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('loading').innerHTML = '<div>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥—ã
        function updateLegend(categories) {
            const legend = document.getElementById('legend');
            legend.innerHTML = '<strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong>';
            
            const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            sorted.forEach(([category, count]) => {
                const color = categoryColors[category] || categoryColors['other'];
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background: ${color};"></div>
                    <span>${category} (${count})</span>
                `;
                legend.appendChild(item);
            });
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        loadReports();
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadReports, 30000);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        tg.onEvent('backButtonClicked', () => {
            tg.close();
        });
    </script>
</body>
</html>
