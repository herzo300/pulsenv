<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—É–ª—å—Å –≥–æ—Ä–æ–¥–∞ ‚Äî –ö–∞—Ä—Ç–∞ –ø—Ä–æ–±–ª–µ–º</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:#0a0a1a; }
        #map { width:100%; height:100vh; }

        .header {
            position:absolute; top:12px; left:50%; transform:translateX(-50%);
            z-index:1000; background:rgba(10,10,26,.92); backdrop-filter:blur(12px);
            padding:12px 28px; border-radius:14px;
            border:1px solid rgba(0,180,255,.2);
            display:flex; align-items:center; gap:12px;
        }
        .header svg { width:28px; height:28px; fill:#00b4ff; }
        .header h1 { font-size:18px; font-weight:800; color:#fff; }
        .header span { font-size:12px; color:rgba(255,255,255,.45); letter-spacing:2px; }

        .stats {
            position:absolute; bottom:20px; left:20px; z-index:1000;
            background:rgba(10,10,26,.92); backdrop-filter:blur(12px);
            padding:16px 20px; border-radius:14px;
            border:1px solid rgba(0,180,255,.15); min-width:180px;
        }
        .stats h3 { font-size:13px; color:rgba(255,255,255,.5); margin-bottom:10px; letter-spacing:1px; text-transform:uppercase; }
        .stat-row { display:flex; justify-content:space-between; padding:5px 0; }
        .stat-row .label { color:rgba(255,255,255,.5); font-size:13px; }
        .stat-row .val { color:#fff; font-weight:700; font-size:14px; }
        .stat-row .val.blue { color:#00b4ff; }
        .stat-row .val.green { color:#4caf50; }
        .stat-row .val.red { color:#ff5252; }

        .legend {
            position:absolute; bottom:20px; right:20px; z-index:1000;
            background:rgba(10,10,26,.92); backdrop-filter:blur(12px);
            padding:14px 18px; border-radius:14px;
            border:1px solid rgba(0,180,255,.15);
            max-height:260px; overflow-y:auto;
        }
        .legend h3 { font-size:13px; color:rgba(255,255,255,.5); margin-bottom:8px; letter-spacing:1px; text-transform:uppercase; }
        .legend-item { display:flex; align-items:center; gap:8px; padding:3px 0; font-size:12px; color:rgba(255,255,255,.7); }
        .legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

        .loading {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            z-index:2000; background:rgba(10,10,26,.95); padding:24px 40px;
            border-radius:14px; border:1px solid rgba(0,180,255,.2);
            color:#fff; font-size:14px; display:flex; align-items:center; gap:12px;
        }
        .spinner { width:24px; height:24px; border:3px solid rgba(0,180,255,.2);
            border-top-color:#00b4ff; border-radius:50%; animation:spin .8s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* –°—Ç–∏–ª—å –ø–æ–ø–∞–ø–æ–≤ */
        .leaflet-popup-content-wrapper {
            background:rgba(10,10,26,.95)!important; color:#fff!important;
            border:1px solid rgba(0,180,255,.2)!important; border-radius:12px!important;
        }
        .leaflet-popup-tip { background:rgba(10,10,26,.95)!important; }
        .popup { min-width:220px; }
        .popup h3 { margin:0 0 8px; font-size:15px; }
        .popup p { margin:4px 0; font-size:13px; color:rgba(255,255,255,.7); }
        .popup .badge { display:inline-block; padding:3px 10px; border-radius:6px; font-size:11px; font-weight:600; }
    </style>
</head>
<body>

<div class="header">
    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
    <div>
        <h1>–ü—É–ª—å—Å –≥–æ—Ä–æ–¥–∞</h1>
        <span>–ù–ò–ñ–ù–ï–í–ê–†–¢–û–í–°–ö</span>
    </div>
</div>

<div id="map"></div>

<div class="stats">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div class="stat-row"><span class="label">–í—Å–µ–≥–æ</span><span class="val blue" id="s-total">‚Äî</span></div>
    <div class="stat-row"><span class="label">–û—Ç–∫—Ä—ã—Ç–æ</span><span class="val red" id="s-open">‚Äî</span></div>
    <div class="stat-row"><span class="label">–†–µ—à–µ–Ω–æ</span><span class="val green" id="s-resolved">‚Äî</span></div>
</div>

<div class="legend" id="legend">
    <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
</div>

<div class="loading" id="loading"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const COLORS = {
    '–î–æ—Ä–æ–≥–∏':'#FF5722','–ñ–ö–•':'#2196F3','–û—Å–≤–µ—â–µ–Ω–∏–µ':'#FFC107','–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç':'#4CAF50',
    '–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ':'#9C27B0','–≠–∫–æ–ª–æ–≥–∏—è':'#00BCD4','–ñ–∏–≤–æ—Ç–Ω—ã–µ':'#FF9800',
    '–¢–æ—Ä–≥–æ–≤–ª—è':'#E91E63','–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å':'#F44336','–°–Ω–µ–≥/–ù–∞–ª–µ–¥—å':'#03A9F4',
    '–ú–µ–¥–∏—Ü–∏–Ω–∞':'#009688','–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ':'#673AB7','–°–≤—è–∑—å':'#3F51B5',
    '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ':'#607D8B','–ü–∞—Ä–∫–æ–≤–∫–∏':'#9E9E9E','–ü—Ä–æ—á–µ–µ':'#795548',
    '–ß–ü':'#D32F2F','–ì–∞–∑–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ':'#FF6F00','–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ –∏ –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è':'#0288D1',
    '–û—Ç–æ–ø–ª–µ–Ω–∏–µ':'#D84315','–ë—ã—Ç–æ–≤–æ–π –º—É—Å–æ—Ä':'#689F38','–õ–∏—Ñ—Ç—ã –∏ –ø–æ–¥—ä–µ–∑–¥—ã':'#455A64',
    '–ü–∞—Ä–∫–∏ –∏ —Å–∫–≤–µ—Ä—ã':'#388E3C','–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏':'#1976D2','–î–µ—Ç—Å–∫–∏–µ –ø–ª–æ—â–∞–¥–∫–∏':'#F06292',
};

const STATUS_LABEL = { pending:'–ù–æ–≤–∞—è', open:'–û—Ç–∫—Ä—ã—Ç–∞', in_progress:'–í —Ä–∞–±–æ—Ç–µ', resolved:'–†–µ—à–µ–Ω–∞', rejected:'–û—Ç–∫–ª–æ–Ω–µ–Ω–∞' };
const STATUS_COLOR = { pending:'#FFC107', open:'#FF5252', in_progress:'#FF9800', resolved:'#4CAF50', rejected:'#9E9E9E' };

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL API (—Ç–æ—Ç –∂–µ —Ö–æ—Å—Ç, –ø–æ—Ä—Ç 8000)
const API = window.location.port === '8000'
    ? window.location.origin
    : window.location.protocol + '//' + window.location.hostname + ':8000';

const map = L.map('map', { zoomControl: false }).setView([60.9344, 76.5531], 13);

L.control.zoom({ position:'topright' }).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'¬© OpenStreetMap', maxZoom:19
}).addTo(map);

const cluster = L.markerClusterGroup({
    maxClusterRadius:50, spiderfyOnMaxZoom:true,
    showCoverageOnHover:false, zoomToBoundsOnClick:true,
    iconCreateFunction(c) {
        const n = c.getChildCount();
        const size = n < 10 ? 36 : n < 50 ? 44 : 52;
        return L.divIcon({
            html:`<div style="
                width:${size}px;height:${size}px;border-radius:50%;
                background:rgba(0,140,255,.85);color:#fff;
                display:flex;align-items:center;justify-content:center;
                font-weight:700;font-size:13px;font-family:Inter,sans-serif;
                border:2px solid rgba(255,255,255,.4);
                box-shadow:0 2px 12px rgba(0,140,255,.5);
            ">${n}</div>`,
            className:'', iconSize:[size,size]
        });
    }
});

function makeIcon(cat) {
    const c = COLORS[cat] || '#795548';
    return L.divIcon({
        className:'',
        html:`<div style="width:28px;height:28px;border-radius:50%;background:${c};
            border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.4);"></div>`,
        iconSize:[28,28], iconAnchor:[14,14]
    });
}

function fmtDate(s) {
    if (!s) return '‚Äî';
    const d = new Date(s);
    return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric'});
}

async function load() {
    try {
        const r = await fetch(API + '/api/reports');
        if (!r.ok) throw new Error(r.status);
        const data = await r.json();
        render(data);
    } catch(e) {
        console.warn('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º /complaints‚Ä¶', e);
        try {
            const r2 = await fetch(API + '/complaints?per_page=100');
            if (!r2.ok) throw new Error(r2.status);
            const j = await r2.json();
            render(j.data || []);
        } catch(e2) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', e2);
            document.getElementById('loading').innerHTML = '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API.';
        }
    }
}

function render(items) {
    cluster.clearLayers();
    let total=0, open=0, resolved=0;
    const cats = {};

    items.forEach(c => {
        const lat = c.latitude ?? c.lat;
        const lng = c.longitude ?? c.lng;
        if (!lat || !lng) return;

        total++;
        const st = c.status || 'open';
        if (st==='open'||st==='pending') open++;
        if (st==='resolved') resolved++;
        cats[c.category] = (cats[c.category]||0) + 1;

        const col = COLORS[c.category] || '#795548';
        const stCol = STATUS_COLOR[st] || '#9E9E9E';
        const stLbl = STATUS_LABEL[st] || st;

        const m = L.marker([lat, lng], { icon: makeIcon(c.category) });
        m.bindPopup(`<div class="popup">
            <h3 style="color:${col}">${c.category || '–ü—Ä–æ—á–µ–µ'}</h3>
            <p><b>${c.title || c.description || '‚Äî'}</b></p>
            <p>üìç ${c.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
            <p>üìÖ ${fmtDate(c.created_at)}</p>
            <span class="badge" style="background:${stCol};color:#fff">${stLbl}</span>
        </div>`);
        cluster.addLayer(m);
    });

    map.addLayer(cluster);
    if (total) {
        try { map.fitBounds(cluster.getBounds(), { padding:[40,40] }); } catch(_){}
    }

    document.getElementById('s-total').textContent = total;
    document.getElementById('s-open').textContent = open;
    document.getElementById('s-resolved').textContent = resolved;

    // –õ–µ–≥–µ–Ω–¥–∞
    const leg = document.getElementById('legend');
    leg.innerHTML = '<h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>';
    Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([cat,n]) => {
        leg.innerHTML += `<div class="legend-item"><div class="legend-dot" style="background:${COLORS[cat]||'#795548'}"></div>${cat} (${n})</div>`;
    });

    document.getElementById('loading').style.display = 'none';
}

load();
setInterval(load, 30000);
</script>
</body>
</html>
