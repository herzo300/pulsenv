# Документ требований: Мониторинг только новых сообщений в реалтайм

## Введение

Система «Пульс города Нижневартовск» мониторит Telegram-каналы и VK-паблики для обнаружения жалоб горожан. Текущая реализация не имеет явной защиты от обработки старых сообщений (с таймстемпом до момента запуска) и дублирования сообщений в Telegram-мониторинге. Данная функция добавляет строгие правила: обрабатывать только сообщения, поступившие после запуска системы, и не обрабатывать одно и то же сообщение дважды.

## Глоссарий

- **Система_Мониторинга** — совокупность модулей `start_monitoring.py`, `start_all_monitoring.py` и `services/vk_monitor_service.py`, отвечающих за получение и обработку сообщений из Telegram и VK
- **Время_Запуска** — момент времени (UTC), зафиксированный при старте Системы_Мониторинга, до начала обработки событий
- **Telegram_Обработчик** — обработчик событий `events.NewMessage` в Telethon, принимающий новые сообщения из Telegram-каналов
- **VK_Поллер** — модуль `vk_monitor_service.py`, опрашивающий стены VK-групп через `wall.get`
- **Множество_Обработанных** — структура данных (set), хранящая идентификаторы уже обработанных сообщений для предотвращения дублирования
- **Таймстемп_Сообщения** — дата и время создания сообщения, предоставляемые API Telegram или VK

## Требования

### Требование 1: Фиксация времени запуска

**User Story:** Как оператор системы, я хочу, чтобы при запуске мониторинга фиксировалось точное время старта, чтобы система могла отличать новые сообщения от старых.

#### Критерии приёмки

1. WHEN Система_Мониторинга запускается, THE Система_Мониторинга SHALL зафиксировать Время_Запуска (UTC) до начала регистрации обработчиков событий
2. WHEN Время_Запуска зафиксировано, THE Система_Мониторинга SHALL записать Время_Запуска в лог в формате ISO 8601

### Требование 2: Фильтрация старых сообщений в Telegram

**User Story:** Как оператор системы, я хочу, чтобы Telegram-обработчик игнорировал сообщения с таймстемпом старше времени запуска, чтобы при подключении не обрабатывались накопившиеся старые сообщения.

#### Критерии приёмки

1. WHEN Telegram_Обработчик получает сообщение с Таймстемп_Сообщения старше Время_Запуска, THE Telegram_Обработчик SHALL пропустить сообщение без обработки и записать в лог причину пропуска
2. WHEN Telegram_Обработчик получает сообщение с Таймстемп_Сообщения равным или новее Время_Запуска, THE Telegram_Обработчик SHALL передать сообщение на дальнейшую обработку

### Требование 3: Дедупликация сообщений в Telegram

**User Story:** Как оператор системы, я хочу, чтобы одно и то же Telegram-сообщение не обрабатывалось дважды, чтобы избежать дублирования публикаций в @monitornv.

#### Критерии приёмки

1. THE Telegram_Обработчик SHALL поддерживать Множество_Обработанных для хранения идентификаторов (channel_id, message_id) обработанных сообщений
2. WHEN Telegram_Обработчик получает сообщение с идентификатором, уже присутствующим в Множество_Обработанных, THE Telegram_Обработчик SHALL пропустить сообщение и записать в лог факт дублирования
3. WHEN Telegram_Обработчик успешно обрабатывает новое сообщение, THE Telegram_Обработчик SHALL добавить идентификатор сообщения в Множество_Обработанных
4. WHEN размер Множество_Обработанных превышает 10000 записей, THE Telegram_Обработчик SHALL удалить старейшие записи, сохранив последние 5000

### Требование 4: Фильтрация старых постов в VK по таймстемпу

**User Story:** Как оператор системы, я хочу, чтобы VK-поллер дополнительно проверял таймстемп постов, чтобы при сбросе множества обработанных постов старые посты не обрабатывались повторно.

#### Критерии приёмки

1. WHEN VK_Поллер получает пост с Таймстемп_Сообщения старше Время_Запуска, THE VK_Поллер SHALL пропустить пост без обработки и записать в лог причину пропуска
2. WHEN VK_Поллер получает пост с Таймстемп_Сообщения равным или новее Время_Запуска, THE VK_Поллер SHALL передать пост на дальнейшую обработку

### Требование 5: Логирование пропущенных сообщений

**User Story:** Как оператор системы, я хочу видеть в логах информацию о пропущенных сообщениях, чтобы контролировать корректность работы фильтров.

#### Критерии приёмки

1. WHEN сообщение пропускается из-за устаревшего таймстемпа, THE Система_Мониторинга SHALL записать в лог уровня INFO: источник, идентификатор сообщения и Таймстемп_Сообщения
2. WHEN сообщение пропускается из-за дублирования, THE Система_Мониторинга SHALL записать в лог уровня DEBUG: источник и идентификатор сообщения
3. WHEN Система_Мониторинга запускается, THE Система_Мониторинга SHALL записать в лог количество пропущенных сообщений по каждой причине в периодической статистике
