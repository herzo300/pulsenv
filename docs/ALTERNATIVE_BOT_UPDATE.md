# Альтернативные способы обновления бота и Web App

## Текущая схема

1. **Деплой Worker:** `py scripts/deployment/deploy_now.py` — обновляет секрет `CF_API_TOKEN` в GitHub и запускает workflow `deploy-worker.yml`.
2. **Обновление бота:** `py scripts/maintenance/update_and_verify_bot.py` — увеличивает версию в `data/webapp_version.json`, обновляет меню команд, проверяет 6 команд.

**Важно:** ссылки на карту и инфографику в боте уже строятся с `?v=<timestamp>` (`time.time()`), а не из файла версии. Файл версии нужен только для отчёта в админ-панели и для кнопки «Обновить бота» в Telegram.

---

## Альтернатива 1: Один скрипт «полный цикл»

Одна команда: деплой Worker → затем обновление бота (bump + меню).

```bash
py scripts/deployment/full_update.py
```

- Вызывает логику деплоя (как `deploy_now.py`).
- Опционально ждёт завершения workflow (опрос GitHub Actions).
- Запускает обновление бота (bump_webapp_version + setup_menu).
- Удобно после правок в `cloudflare-worker/` и в боте.

Файл: `scripts/deployment/full_update.py`.

---

## Альтернатива 2: Обновление только из Telegram (админ)

Уже есть: **Админ-панель → Управление ботом → «Обновить бота»**.

- На сервере выполняется: `bump_webapp_version()` + `setup_menu()`.
- Не нужен доступ к консоли.
- Деплой Worker при этом не запускается — только «версия» и меню. Деплой по-прежнему через push в GitHub или `deploy_now.py`.

---

## Альтернатива 3: Версия только по timestamp (без файла)

Сейчас URL карты/инфографики уже с `?v=<timestamp>`. Можно:

- Не вызывать `bump_webapp_version()` вообще.
- Убрать зависимость от `data/webapp_version.json` для формирования ссылок (оставить только для отчёта в админке, если нужно).
- Обновление меню — по кнопке в админке или при старте бота (см. альтернативу 5).

Итог: «обновление» карты/инфографики происходит автоматически при каждом открытии (новый `?v=`), скрипт для bump не обязателен.

---

## Альтернатива 4: GitHub Actions обновляет бота после деплоя

После успешного деплоя Worker добавить шаг, который дергает ваш бэкенд:

```yaml
# в .github/workflows/deploy-worker.yml после deploy
- name: Notify backend to refresh bot
  run: |
    curl -X POST "${{ secrets.BACKEND_URL }}/internal/refresh-webapp" \
      -H "Authorization: Bearer ${{ secrets.INTERNAL_SECRET }}"
```

На бэкенде (FastAPI):

- Эндпоинт `POST /internal/refresh-webapp` (проверка `INTERNAL_SECRET`).
- Внутри: `bump_webapp_version()` + вызов `setup_menu()` (через asyncio или отдельный воркер).

Плюс: push в `main` → деплой Worker → автоматическое обновление бота. Минус: нужен доступный URL бэкенда и секреты в GitHub.

---

## Альтернатива 5: Обновление меню при старте бота

При запуске `main.py` (или воркера с ботом) один раз вызвать `setup_menu()`.

- Меню всегда актуально после рестарта.
- Версию по-прежнему можно не трогать (timestamp в URL) или bump только при деплое/по кнопке в админке.

---

## Сводка

| Способ | Деплой Worker | Bump версии | Меню | Когда использовать |
|--------|----------------|-------------|------|--------------------|
| Текущий (2 скрипта) | deploy_now.py | update_and_verify_bot.py | там же | Ручной полный цикл |
| **Полный цикл** (1 скрипт) | full_update.py | full_update.py | там же | Одна команда после правок |
| Только из Telegram | — | Кнопка «Обновить бота» | да | Не трогая сервер |
| Только timestamp | deploy_now / push | не нужен | отдельно | Минимум ручных действий по версии |
| GitHub Actions | push → workflow | опционально через API | через API | Полная автоматизация после push |
| Меню при старте | — | по желанию | при старте бота | Всегда свежее меню после рестарта |

Рекомендация: оставить формирование ссылок по `time.time()`; для удобства использовать **полный цикл** (`full_update.py`) или кнопку в админке, когда нужно явно «обновить бота» после деплоя.
